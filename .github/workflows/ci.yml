name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  typecheck:
    name: Type Check (${{ matrix.app }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - control-plane-api
          - voice-runtime-worker
          - agent-runner
          - agent-connector
          - ops-debug-web
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: apps/${{ matrix.app }}/package-lock.json

      - name: Install dependencies
        run: npm ci --prefix apps/${{ matrix.app }}

      - name: Run check
        run: npm --prefix apps/${{ matrix.app }} run check

  automation-e2e-smoke-mock:
    name: Automation E2E Smoke (Mock)
    needs: typecheck
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: livekit_voice_ops
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d livekit_voice_ops"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/livekit_voice_ops
      JWT_SECRET: 9b211cb5b27643e7b8d19c2d1f2af6518dc6c1480d3c38058df3a4dc6d9882b7
      JWT_ISSUER: voice-ops-ci
      JWT_AUDIENCE: voice-ops-api
      ENCRYPTION_KEY: 49e74ad76b330fcc7f20244357f13b3e73ae79015e6dadd45e194b1d1e245619
      DEV_BOOTSTRAP_KEY: ci-bootstrap-key
      CONNECTOR_AUTH_TOKEN: ci-connector-token
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install app dependencies
        run: |
          npm ci --prefix apps/control-plane-api
          npm ci --prefix apps/agent-connector

      - name: Install postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply migrations
        run: |
          for migration in db/migrations/*.sql; do
            PGPASSWORD=postgres psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$migration"
          done

      - name: Prepare service env files
        run: |
          cat > apps/control-plane-api/.env <<EOF
          NODE_ENV=development
          HOST=0.0.0.0
          PORT=4000
          DATABASE_URL=$DATABASE_URL
          JWT_SECRET=$JWT_SECRET
          JWT_ISSUER=$JWT_ISSUER
          JWT_AUDIENCE=$JWT_AUDIENCE
          ENCRYPTION_KEY=$ENCRYPTION_KEY
          N8N_TEST_TIMEOUT_MS=3000
          N8N_TEST_RETRIES=2
          DEV_BOOTSTRAP_KEY=$DEV_BOOTSTRAP_KEY
          TWILIO_VALIDATE_SIGNATURE=false
          TWILIO_WEBHOOK_BASE_URL=http://localhost:4000
          EOF

          GATEWAY_TOKEN=$(node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({sub:'ci-connector',tenant_id:'bootstrap-tenant',role:'internal_admin',is_internal:true}, process.env.JWT_SECRET, {issuer:process.env.JWT_ISSUER,audience:process.env.JWT_AUDIENCE,expiresIn:'2h'}));")

          cat > apps/agent-connector/.env <<EOF
          NODE_ENV=development
          HOST=0.0.0.0
          PORT=4200
          CONNECTOR_AUTH_TOKEN=$CONNECTOR_AUTH_TOKEN
          DATABASE_URL=$DATABASE_URL
          AGENT_CONNECTOR_MOCK_AI=true
          OPENAI_API_KEY=
          OPENAI_BASE_URL=https://api.openai.com/v1
          OPENAI_MODEL_FALLBACK=gpt-4o-mini
          MOCK_N8N_AUTH_SECRET=local-dev-secret
          AUTOMATION_GATEWAY_BASE_URL=http://localhost:4000
          AUTOMATION_GATEWAY_BEARER_TOKEN=$GATEWAY_TOKEN
          AUTOMATION_TOOL_COMMAND_PREFIX=/tool
          AUTOMATION_GATEWAY_TIMEOUT_MS=15000
          AUTOMATION_LLM_TOOL_CALLS_ENABLED=true
          EOF

      - name: Start services
        run: |
          nohup npm --prefix apps/control-plane-api run dev > /tmp/control-plane-ci.log 2>&1 &
          nohup npm --prefix apps/agent-connector run dev > /tmp/agent-connector-ci.log 2>&1 &

      - name: Wait for health
        run: |
          for i in {1..40}; do
            if curl -sf http://localhost:4000/health >/dev/null && curl -sf http://localhost:4200/health >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Services failed to start"
          cat /tmp/control-plane-ci.log || true
          cat /tmp/agent-connector-ci.log || true
          exit 1

      - name: Run automation e2e smoke test
        run: E2E_MODE=mock ./scripts/automation-e2e-smoke-test.sh

      - name: Print logs on failure
        if: failure()
        run: |
          cat /tmp/control-plane-ci.log || true
          cat /tmp/agent-connector-ci.log || true

  automation-e2e-smoke-openai:
    name: Automation E2E Smoke (OpenAI)
    needs: typecheck
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && secrets.OPENAI_API_KEY != '' }}
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: livekit_voice_ops
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d livekit_voice_ops"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/livekit_voice_ops
      JWT_SECRET: 9b211cb5b27643e7b8d19c2d1f2af6518dc6c1480d3c38058df3a4dc6d9882b7
      JWT_ISSUER: voice-ops-ci
      JWT_AUDIENCE: voice-ops-api
      ENCRYPTION_KEY: 49e74ad76b330fcc7f20244357f13b3e73ae79015e6dadd45e194b1d1e245619
      DEV_BOOTSTRAP_KEY: ci-bootstrap-key
      CONNECTOR_AUTH_TOKEN: ci-connector-token
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install app dependencies
        run: |
          npm ci --prefix apps/control-plane-api
          npm ci --prefix apps/agent-connector

      - name: Install postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply migrations
        run: |
          for migration in db/migrations/*.sql; do
            PGPASSWORD=postgres psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$migration"
          done

      - name: Prepare service env files
        run: |
          cat > apps/control-plane-api/.env <<EOF
          NODE_ENV=development
          HOST=0.0.0.0
          PORT=4000
          DATABASE_URL=$DATABASE_URL
          JWT_SECRET=$JWT_SECRET
          JWT_ISSUER=$JWT_ISSUER
          JWT_AUDIENCE=$JWT_AUDIENCE
          ENCRYPTION_KEY=$ENCRYPTION_KEY
          N8N_TEST_TIMEOUT_MS=3000
          N8N_TEST_RETRIES=2
          DEV_BOOTSTRAP_KEY=$DEV_BOOTSTRAP_KEY
          TWILIO_VALIDATE_SIGNATURE=false
          TWILIO_WEBHOOK_BASE_URL=http://localhost:4000
          EOF

          GATEWAY_TOKEN=$(node -e "const jwt=require('jsonwebtoken'); console.log(jwt.sign({sub:'ci-connector',tenant_id:'bootstrap-tenant',role:'internal_admin',is_internal:true}, process.env.JWT_SECRET, {issuer:process.env.JWT_ISSUER,audience:process.env.JWT_AUDIENCE,expiresIn:'2h'}));")

          cat > apps/agent-connector/.env <<EOF
          NODE_ENV=development
          HOST=0.0.0.0
          PORT=4200
          CONNECTOR_AUTH_TOKEN=$CONNECTOR_AUTH_TOKEN
          DATABASE_URL=$DATABASE_URL
          AGENT_CONNECTOR_MOCK_AI=false
          OPENAI_API_KEY=$OPENAI_API_KEY
          OPENAI_BASE_URL=https://api.openai.com/v1
          OPENAI_MODEL_FALLBACK=gpt-4o-mini
          MOCK_N8N_AUTH_SECRET=local-dev-secret
          AUTOMATION_GATEWAY_BASE_URL=http://localhost:4000
          AUTOMATION_GATEWAY_BEARER_TOKEN=$GATEWAY_TOKEN
          AUTOMATION_TOOL_COMMAND_PREFIX=/tool
          AUTOMATION_GATEWAY_TIMEOUT_MS=15000
          AUTOMATION_LLM_TOOL_CALLS_ENABLED=true
          EOF

      - name: Start services
        run: |
          nohup npm --prefix apps/control-plane-api run dev > /tmp/control-plane-ci.log 2>&1 &
          nohup npm --prefix apps/agent-connector run dev > /tmp/agent-connector-ci.log 2>&1 &

      - name: Wait for health
        run: |
          for i in {1..40}; do
            if curl -sf http://localhost:4000/health >/dev/null && curl -sf http://localhost:4200/health >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Services failed to start"
          cat /tmp/control-plane-ci.log || true
          cat /tmp/agent-connector-ci.log || true
          exit 1

      - name: Run automation e2e smoke test
        run: E2E_MODE=openai ./scripts/automation-e2e-smoke-test.sh

      - name: Print logs on failure
        if: failure()
        run: |
          cat /tmp/control-plane-ci.log || true
          cat /tmp/agent-connector-ci.log || true
